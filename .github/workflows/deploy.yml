name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_STATE: "rg-rag-tfstate"
  STORAGE_ACCOUNT_STATE: "sttfstatehv3yil" # Hardcoded val from bootstrap
  CONTAINER_STATE: "tfstate"

jobs:
  # --- CI STAGE ---
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Ruff
        run: pip install ruff
      - name: Run Ruff check
        run: cd backend && ruff check .
      - name: Run Ruff format check
        run: cd backend && ruff format --check .

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_rag_system
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      qdrant:
        image: qdrant/qdrant:v1.12.1
        ports:
          - 6333:6333
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: cd backend && pip install -e ".[dev]"
      - name: Run tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_rag_system
          QDRANT_HOST: localhost
          QDRANT_PORT: 6333
          API_KEY: test-key
          OPENAI_API_KEY: sk-test
          OPENAI_EMBEDDING_MODEL: text-embedding-3-small
          OPENAI_CHAT_MODEL: gpt-4o
        run: cd backend && python -m pytest

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Run tests
        run: cd frontend && npx jest --passWithNoTests

  # --- BUILD STAGE ---
  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name acrragdevsecup7

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: acrragdevsecup7.azurecr.io/backend:latest,acrragdevsecup7.azurecr.io/backend:${{ github.sha }}

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: acrragdevsecup7.azurecr.io/frontend:latest,acrragdevsecup7.azurecr.io/frontend:${{ github.sha }}

  # --- DEPLOY STAGE ---
  deploy-infra:
    name: Deploy Infrastructure
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # Permanent Stack
      - name: TF Init (Permanent)
        working-directory: ./infra/terraform/permanent
        run: |
          terraform init \
            -backend-config="resource_group_name=$RESOURCE_GROUP_STATE" \
            -backend-config="storage_account_name=$STORAGE_ACCOUNT_STATE" \
            -backend-config="container_name=$CONTAINER_STATE" \
            -backend-config="key=permanent.tfstate"

      - name: TF Apply (Permanent)
        working-directory: ./infra/terraform/permanent
        run: terraform apply -auto-approve -var="subscription_id=$AZURE_SUBSCRIPTION_ID"

      # Ephemeral Stack
      - name: TF Init (Ephemeral)
        working-directory: ./infra/terraform/ephemeral
        run: |
          terraform init \
            -backend-config="resource_group_name=$RESOURCE_GROUP_STATE" \
            -backend-config="storage_account_name=$STORAGE_ACCOUNT_STATE" \
            -backend-config="container_name=$CONTAINER_STATE" \
            -backend-config="key=ephemeral.tfstate"

      - name: TF Apply (Ephemeral)
        working-directory: ./infra/terraform/ephemeral
        run: terraform apply -auto-approve
